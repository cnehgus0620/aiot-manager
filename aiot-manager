register_env(){
  echo "=== AIoT Gateway Auto Register (Thing + Certificate + Firehose) ==="
  have_cmd aws || { echo "[ERROR] awscli ë¯¸ì„¤ì¹˜. 'aiot-manager check' ì‹¤í–‰ í•„ìš”."; return 1; }
  have_cmd jq || { echo "[ERROR] jq ë¯¸ì„¤ì¹˜. 'aiot-manager check' ì‹¤í–‰ í•„ìš”."; return 1; }
  aws sts get-caller-identity >/dev/null 2>&1 || { echo "[ERROR] AWS CLI ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤."; echo "aws configure ì‹¤í–‰ í›„ ì¬ì‹œë„."; return 1; }

  ping -c1 amazonaws.com >/dev/null 2>&1 || { echo "[ERROR] ë„¤íŠ¸ì›Œí¬ ì—°ê²° ë¶ˆê°€."; return 1; }

  echo "[1/6] ë””ë°”ì´ìŠ¤ ìœ í˜• ì„ íƒ"
  echo "1) Raspberry Pi"
  echo "2) Jetson Nano"
  read -r -p "ì„ íƒ (1 ë˜ëŠ” 2): " dev_sel
  case "$dev_sel" in
    1) prefix="RaspberryPi5_IoT_Thing_Gateway_" ;;
    2) prefix="JetsonNano_IoT_Thing_Gateway_" ;;
    *) echo "[WARN] ì˜ëª»ëœ ì…ë ¥ â†’ ê¸°ë³¸ê°’ RaspberryPi5 ì‚¬ìš©"; prefix="RaspberryPi5_IoT_Thing_Gateway_" ;;
  esac

  echo "[2/6] ê¸°ì¡´ Thing ì¡°íšŒ ì¤‘..."
  existing=$(aws iot list-things --query "things[?starts_with(thingName, '${prefix}')].thingName" --output text)
  if [ -n "$existing" ]; then
    last=$(echo "$existing" | grep -Eo '[0-9]+$' | sort -n | tail -1)
    next=$((last + 1))
  else
    next=1
  fi
  thing_name="${prefix}${next}"
  echo "[OK] ìƒˆ Thing ì´ë¦„: ${thing_name}"

  if aws iot describe-thing --thing-name "$thing_name" >/dev/null 2>&1; then
    echo "[ERROR] Thing ${thing_name} ì´ë¯¸ ì¡´ì¬í•¨."; return 1
  fi

  aws iot create-thing --thing-name "$thing_name" >/dev/null
  echo "[OK] Thing ìƒì„± ì™„ë£Œ"

  mkdir -p /iotcert
  CERT_JSON=$(aws iot create-keys-and-certificate --set-as-active \
    --certificate-pem-outfile  "/iotcert/${thing_name}.cert.pem" \
    --private-key-outfile      "/iotcert/${thing_name}.private.key" \
    --public-key-outfile       "/iotcert/${thing_name}.public.key")
  CERT_ARN=$(echo "$CERT_JSON" | jq -r .certificateArn)
  CERT_ID=$(echo "$CERT_JSON" | jq -r .certificateId)
  echo "[OK] ì¸ì¦ì„œ ë°œê¸‰ ì™„ë£Œ (ID=${CERT_ID})"

  # Root CA ë‹¤ìš´ë¡œë“œ
  [ -f /iotcert/AmazonRootCA1.pem ] || wget -q https://www.amazontrust.com/repository/AmazonRootCA1.pem -O /iotcert/AmazonRootCA1.pem

  # ============================
  # ğŸ” ì •ì±… ìë™ ë¶„ê¸° ë¡œì§ (NEW)
  # ============================
  if aws iot list-policies --query "policies[?policyName=='IoTRuleRole-FirehoseToS3']" --output text | grep -q 'IoTRuleRole-FirehoseToS3'; then
    POLICY="IoTRuleRole-FirehoseToS3"
    echo "[INFO] Firehoseìš© ì—­í•  ì •ì±… ê°ì§€ë¨ â†’ ${POLICY} ì‚¬ìš©"
  else
    POLICY="MyIoTDevicePolicy"
    if ! aws iot list-policies --query "policies[?policyName=='${POLICY}']" --output text | grep -q "$POLICY"; then
      echo "[WARN] ${POLICY} ë¯¸ì¡´ì¬ â†’ ìƒˆë¡œ ìƒì„± ì¤‘..."
      aws iot create-policy --policy-name "$POLICY" \
        --policy-document '{"Version":"2012-10-17","Statement":[{"Effect":"Allow","Action":["iot:Connect","iot:Publish","iot:Receive","iot:Subscribe"],"Resource":"*"}]}'
    else
      echo "[INFO] ${POLICY} ì´ë¯¸ ì¡´ì¬í•¨"
    fi
  fi

  # ì •ì±… ë° ì¸ì¦ì„œ ì—°ê²°
  aws iot attach-policy --policy-name "$POLICY" --target "$CERT_ARN"
  aws iot attach-thing-principal --thing-name "$thing_name" --principal "$CERT_ARN"
  echo "[OK] ì •ì±… ì—°ê²° ì™„ë£Œ (${POLICY})"

  firehose=$(aws firehose list-delivery-streams --query 'deliveryStreamNames[0]' --output text)
  echo "[INFO] ì—°ê²°ëœ Firehose: ${firehose:-ì—†ìŒ}"

  ENDPOINT=$(aws iot describe-endpoint --endpoint-type iot:Data-ATS --query 'endpointAddress' --output text)
  cat <<EOD | tee /etc/default/aiot >/dev/null
THING_NAME=${thing_name}
IOT_ENDPOINT=${ENDPOINT}
CA_PATH=/iotcert/AmazonRootCA1.pem
CERT_PATH=/iotcert/${thing_name}.cert.pem
KEY_PATH=/iotcert/${thing_name}.private.key
DB_PATH=/aiot/dataset/sensor_data.db
ROOM=room-${next}
QOS=1
EOD

  chown aiot:aiot /iotcert/*.pem
  chmod 600 /iotcert/${thing_name}.private.key
  chmod 644 /etc/default/aiot

  echo "[ì™„ë£Œ] Thing=${thing_name}, Room=room-${next}"
  echo "â†’ AWS IoT Core + Firehose ì—°ê²° ì™„ë£Œ"
}
