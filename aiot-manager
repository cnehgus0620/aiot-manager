#!/usr/bin/env bash
# AIoT collector/publisher 통합 관리 스크립트
# 기능: register / configure / check / status / collector / publisher
set -euo pipefail

APP_DIR="/opt/aiot"
VENV="${APP_DIR}/venv"
COLLECTOR="${APP_DIR}/mqtt_to_sqlite.py"
PUBLISHER="${APP_DIR}/sqlite_to_iotcore.py"
LOG_DIR="/var/log/aiot"
PID_DIR="/run/aiot"
SUDO=${SUDO:-sudo}

[ -f /etc/default/aiot ] && set -a && . /etc/default/aiot && set +a
mkdir -p "$LOG_DIR" "$PID_DIR"

# ------------------ 공용 유틸 ------------------
have_cmd(){ command -v "$1" >/dev/null 2>&1; }
is_running(){ pgrep -f -- "$1" >/dev/null 2>&1; }

print_os_info(){
  echo "== system =="
  if [ -f /etc/os-release ]; then . /etc/os-release; echo "OS        : ${PRETTY_NAME:-Unknown}"; else echo "OS        : Unknown"; fi
  echo "Kernel    : $(uname -r)"
  echo "Arch      : $(uname -m)"
  echo "Hostname  : $(hostname)"
}

prompt_int(){
  local msg="$1" var
  while :; do
    read -r -p "$msg" var
    [[ "$var" =~ ^[0-9]+$ ]] && { echo "$var"; return 0; }
    echo "숫자만 입력하세요."
  done
}

# ------------------ OS 패키지 ------------------
detect_pkg_mgr(){
  if have_cmd apt-get; then echo "apt"
  elif have_cmd dnf; then echo "dnf"
  elif have_cmd yum; then echo "yum"
  elif have_cmd pacman; then echo "pacman"
  elif have_cmd zypper; then echo "zypper"
  else echo "unknown"; fi
}

required_os_packages(){
  case "$1" in
    apt) echo "python3 python3-venv python3-pip mosquitto mosquitto-clients jq ca-certificates awscli" ;;
    dnf|yum) echo "python3 python3-virtualenv python3-pip mosquitto mosquitto-clients jq ca-certificates awscli" ;;
    pacman) echo "python python-pip python-virtualenv mosquitto jq ca-certificates aws-cli" ;;
    zypper) echo "python3 python3-pip python3-virtualenv mosquitto jq ca-certificates aws-cli" ;;
    *) echo "" ;;
  esac
}

pkg_installed(){
  local mgr="$1" pkg="$2"
  case "$mgr" in
    apt) dpkg -s "$pkg" >/dev/null 2>&1 ;;
    dnf|yum|zypper) rpm -q "$pkg" >/dev/null 2>&1 ;;
    pacman) pacman -Q "$pkg" >/dev/null 2>&1 ;;
    *) return 1 ;;
  esac
}

install_packages(){
  local mgr="$1"; shift
  local pkgs=("$@")
  case "$mgr" in
    apt) $SUDO apt-get update && $SUDO DEBIAN_FRONTEND=noninteractive apt-get install -y "${pkgs[@]}" ;;
    dnf) $SUDO dnf install -y "${pkgs[@]}" ;;
    yum) $SUDO yum install -y "${pkgs[@]}" ;;
    pacman) $SUDO pacman -Sy --noconfirm "${pkgs[@]}" ;;
    zypper) $SUDO zypper --non-interactive install "${pkgs[@]}" ;;
  esac
}

check_os_packages(){
  local mgr list missing=()
  mgr="$(detect_pkg_mgr)"
  list="$(required_os_packages "$mgr")"
  [ -z "$list" ] && { echo "[WARN] 패키지 관리자 인식 실패"; return 0; }

  for p in $list; do pkg_installed "$mgr" "$p" || missing+=("$p"); done

  if (( ${#missing[@]} )); then
    echo "== missing OS packages =="; printf ' - %s\n' "${missing[@]}"
    read -r -p "설치하시겠습니까? [Y/n] " ans; ans=${ans:-Y}
    [[ "$ans" =~ ^[Yy]$ ]] && install_packages "$mgr" "${missing[@]}"
  else
    echo "== OS packages =="; echo "모든 필수 패키지 설치됨."
  fi
}

# ------------------ Python / venv ------------------
ensure_venv(){
  echo "== python venv =="
  if [ -x "${VENV}/bin/python" ]; then echo "존재: ${VENV}"; return; fi
  read -r -p "가상환경이 없습니다. 생성하시겠습니까? [Y/n] " ans; ans=${ans:-Y}
  [[ "$ans" =~ ^[Yy]$ ]] || return
  $SUDO -u "$(stat -c %U "$APP_DIR")" python3 -m venv "$VENV"
  $SUDO -u "$(stat -c %U "$APP_DIR")" "${VENV}/bin/pip" install --upgrade pip
}

check_python_pkgs(){
  local missing=()
  for m in paho-mqtt boto3 AWSIoTPythonSDK; do
    "${VENV}/bin/pip" show "$m" >/dev/null 2>&1 || missing+=("$m")
  done
  if (( ${#missing[@]} )); then
    echo "== missing python packages =="; printf ' - %s\n' "${missing[@]}"
    read -r -p "venv에 설치하시겠습니까? [Y/n] " ans; ans=${ans:-Y}
    [[ "$ans" =~ ^[Yy]$ ]] && "${VENV}/bin/pip" install "${missing[@]}"
  else
    echo "== python packages =="; echo "모든 필수 모듈 설치됨."
  fi
}

# ------------------ AIoT Thing 자동 등록 ------------------
register_env(){
  echo "=== AIoT Gateway Auto Register (Thing + Certificate + Firehose) ==="
  have_cmd aws || { echo "[ERROR] awscli 미설치. 'aiot-manager check' 실행 필요."; return 1; }
  have_cmd jq || { echo "[ERROR] jq 미설치. 'aiot-manager check' 실행 필요."; return 1; }

  aws sts get-caller-identity >/dev/null 2>&1 || { echo "[ERROR] AWS CLI 인증이 필요합니다."; echo "aws configure 실행 후 재시도."; return 1; }

  ping -c1 amazonaws.com >/dev/null 2>&1 || { echo "[ERROR] 네트워크 연결 불가."; return 1; }

  echo "[1/6] 디바이스 유형 선택"
  echo "1) Raspberry Pi"
  echo "2) Jetson Nano"
  read -r -p "선택 (1 또는 2): " dev_sel
  case "$dev_sel" in
    1) prefix="RaspberryPi5_IoT_Thing_Gateway_" ;;
    2) prefix="JetsonNano_IoT_Thing_Gateway_" ;;
    *) echo "[WARN] 잘못된 입력 → 기본값 RaspberryPi5 사용"; prefix="RaspberryPi5_IoT_Thing_Gateway_" ;;
  esac

  echo "[2/6] 기존 Thing 조회 중..."
  existing=$(aws iot list-things --query "things[?starts_with(thingName, '${prefix}')].thingName" --output text)
  if [ -n "$existing" ]; then
    last=$(echo "$existing" | grep -Eo '[0-9]+$' | sort -n | tail -1)
    next=$((last + 1))
  else
    next=1
  fi
  thing_name="${prefix}${next}"
  echo "[OK] 새 Thing 이름: ${thing_name}"

  if aws iot describe-thing --thing-name "$thing_name" >/dev/null 2>&1; then
    echo "[ERROR] Thing ${thing_name} 이미 존재함."; return 1
  fi

  aws iot create-thing --thing-name "$thing_name" >/dev/null
  echo "[OK] Thing 생성 완료"

  mkdir -p /iotcert
  CERT_JSON=$(aws iot create-keys-and-certificate --set-as-active \
    --certificate-pem-outfile  "/iotcert/${thing_name}.cert.pem" \
    --private-key-outfile      "/iotcert/${thing_name}.private.key" \
    --public-key-outfile       "/iotcert/${thing_name}.public.key")
  CERT_ARN=$(echo "$CERT_JSON" | jq -r .certificateArn)
  CERT_ID=$(echo "$CERT_JSON" | jq -r .certificateId)
  echo "[OK] 인증서 발급 완료 (ID=${CERT_ID})"

  [ -f /iotcert/AmazonRootCA1.pem ] || wget -q https://www.amazontrust.com/repository/AmazonRootCA1.pem -O /iotcert/AmazonRootCA1.pem

  POLICY="MyIoTPolicy"
  if ! aws iot list-policies --query "policies[?policyName=='${POLICY}']" --output text | grep -q "$POLICY"; then
    echo "[WARN] Policy ${POLICY} 미존재 → 자동 생성"
    aws iot create-policy --policy-name "$POLICY" \
      --policy-document '{"Version":"2012-10-17","Statement":[{"Effect":"Allow","Action":["iot:Connect","iot:Publish","iot:Receive","iot:Subscribe"],"Resource":"*"}]}'
  fi
  aws iot attach-policy --policy-name "$POLICY" --target "$CERT_ARN"
  aws iot attach-thing-principal --thing-name "$thing_name" --principal "$CERT_ARN"
  echo "[OK] 정책 및 연결 완료 (${POLICY})"

  firehose=$(aws firehose list-delivery-streams --query 'deliveryStreamNames[0]' --output text)
  echo "[INFO] 연결된 Firehose: ${firehose:-없음}"

  ENDPOINT=$(aws iot describe-endpoint --endpoint-type iot:Data-ATS --query 'endpointAddress' --output text)
  cat <<EOD | tee /etc/default/aiot >/dev/null
THING_NAME=${thing_name}
IOT_ENDPOINT=${ENDPOINT}
CA_PATH=/iotcert/AmazonRootCA1.pem
CERT_PATH=/iotcert/${thing_name}.cert.pem
KEY_PATH=/iotcert/${thing_name}.private.key
DB_PATH=/aiot/dataset/sensor_data.db
ROOM=room-${next}
QOS=1
EOD

  chown aiot:aiot /iotcert/*.pem
  chmod 600 /iotcert/${thing_name}.private.key
  chmod 644 /etc/default/aiot

  echo "[완료] Thing=${thing_name}, Room=room-${next}"
  echo "→ AWS IoT Core + Firehose 연결 완료"
}

# ------------------ 기존 configure 이하 그대로 유지 ------------------
# (configure_env, start_collector, start_publisher, stop_role, status_role, check_all, usage)

# ------------------ main entry ------------------
main(){
  local cmd="${1:-}"; shift || true
  case "$cmd" in
    register) register_env ;;
    configure) configure_env ;;
    check) check_all ;;
    status) status_role ;;
    collector) case "${1:-}" in start) start_collector;; stop) stop_role collector;; restart) stop_role collector; start_collector;; *) usage;; esac ;;
    publisher) case "${1:-}" in start) start_publisher;; stop) stop_role publisher;; restart) stop_role publisher; start_publisher;; *) usage;; esac ;;
    *) usage ;;
  esac
}

main "$@"
